const express = require('express');
const sql = require('sqlite3');
const path = require('path');
const buildHTML = require('build-html');
const template = require('site-template');

const app = express();
const dbFile = path.resolve('./BLOG');
const db = new sql.Database(dbFile);

const go = () => {
  app.use('/js', express.static('js'));

  app.get('/writing/:slug', (req, res) => {
    db.all('SELECT * from posts', (e, d) => {
      const post = d.find(x => x.slug === req.params.slug);
      if (post) {
        const { html } = buildHTML('post', post);
        const responseHTML = template(
          'adamsimpson.net',
          'blah',
          html,
          req.params.slug
        );
        res.send(responseHTML);
      } else {
        res.send(`post: ${req.params.slug} not found`);
      }
    });
  });

  app.get('/', (req, res) => {
    db.all('SELECT * from posts', (e, d) => {
      const posts = d
        .map(x => ({
          excerpt: x.excerpt,
          slug: x.slug,
          date: x.pub_date,
          title: x.title,
        }))
        .reverse();

      const postData = {
        posts: posts.slice(0, 10),
        total: posts.length,
        current: 0,
      };
      const { html } = buildHTML('list', postData);
      const temp = template(
        'adamsimpson.net',
        'The design and development log of Adam Simpson.',
        html,
        ''
      );
      res.send(temp);
    });
  });

  app.listen(4000, () => {
    console.log('ðŸŽ‰ adamnet available on :4000!');
  });
};

module.exports = go;
